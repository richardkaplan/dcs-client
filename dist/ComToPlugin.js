var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},i=function(){function o(){t(this,o),this._listeners={}}return n(o,[{key:"on",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._listeners[e]||(this._listeners[e]=[]),t._priority=parseInt(n)||0,-1===this._listeners[e].indexOf(t)&&(this._listeners[e].push(t),this._listeners[e].length>1&&this._listeners[e].sort(this.listenerSorter))}},{key:"listenerSorter",value:function(e,t){return e._priority-t._priority}},{key:"off",value:function(e,t){if(void 0!==this._listeners[e])if(void 0!==t){var n=this._listeners[e].indexOf(t);-1<n&&this._listeners[e].splice(n,1)}else delete this._listeners[e]}},{key:"trigger",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t&&(t={type:t,data:"object"===(void 0===n?"undefined":e(n))&&null!==n?n:{}}),void 0!==this._listeners[t.type])for(var o=this._listeners[t.type].length-1;o>=0;o--)this._listeners[t.type][o](t)}},{key:"destroy",value:function(){this._listeners={}}}]),o}(),r=function(r){function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100*Math.random()|0;t(this,s);var n=o(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return n.id="BELLHOP:"+e,n.connected=!1,n.isChild=!0,n.connecting=!1,n.origin="*",n._sendLater=[],n.iframe=null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(s,i),n(s,[{key:"receive",value:function(t){if(this.target===t.source)if("connected"===t.data)this.onConnectionReceived(t.data);else{var n=t.data;if("string"==typeof n)try{n=JSON.parse(n)}catch(t){console.error("Bellhop error: ",t)}this.connected&&"object"===(void 0===n?"undefined":e(n))&&n.type&&this.trigger(n)}}},{key:"onConnectionReceived",value:function(e){this.connecting=!1,this.connected=!0,this.isChild||this.target.postMessage(e,this.origin);for(var t=0;t<this._sendLater.length;t++){var n=this._sendLater[t],o=n.type,i=n.data;this.send(o,i)}this._sendLater.length=0,this.trigger("connected")}},{key:"connect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"*";this.connecting||(this.disconnect(),this.connecting=!0,e instanceof HTMLIFrameElement&&(this.iframe=e),this.isChild=void 0===e,this.supported=!0,this.isChild&&(this.supported=window!=e),this.origin=t,window.addEventListener("message",this.receive.bind(this)),this.isChild&&(window===this.target?this.trigger("failed"):this.target.postMessage("connected",this.origin)))}},{key:"disconnect",value:function(){this.connected=!1,this.connecting=!1,this.origin=null,this.iframe=null,this.isChild=!0,this._sendLater.length=0,window.removeEventListener("message",this.receive)}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"!=typeof e)throw"The event type must be a string";var n={type:e,data:t};this.connecting?this._sendLater.push(n):this.target.postMessage(JSON.stringify(n),this.origin)}},{key:"fetch",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";this.on(e,function e(o){i&&n.off(o.type,e),t(o)}),this.send(e,o)}},{key:"respond",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(e,function i(r){o&&t.off(r.type,i),t.send(e,"function"==typeof n?n():n)})}},{key:"destroy",value:function(){(function e(t,n,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,o)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(o):void 0})(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"destroy",this).call(this),this.disconnect(),this._sendLater.length=0}},{key:"target",get:function(){return this.isChild?window.parent:this.iframe.contentWindow}}]),s}();const s={windowName:()=>{let e="Docuss";return(e="undefined"!=typeof window?window.name.trim()||document.title.trim()||e:require(__dirname+"/package.json").name||e).substring(0,12)},log:(...e)=>{e=[`%c${s.windowName()} -`,"color:grey",...e],console.log(...e)},logError:(...e)=>{e=[`%c${s.windowName()} %c- Docuss Error -`,"color:grey","color:red",...e],console.log(...e)},logWarning:(...e)=>{e=[`%c${s.windowName()} %c- Docuss Warning -`,"color:grey","color:orange",...e],console.log(...e)}};class c extends Error{constructor(e){super(e),this.name="DocussError"}}s.throw=(e=>{throw new c(e)}),s.throwIf=((e,t)=>e&&s.throw(t)),s.throwIfNot=((e,t)=>!e&&s.throw(t)),s.dev={assert:(e,t)=>s.throwIf(!e,`Assertion Failed${t?" - "+t:""}`),log:s.log,logWarning:s.logWarning,logError:s.logError},s.inIFrame=(()=>{try{return window.self!==window.top}catch(e){return!0}}),s.async={promiseState(e){const t={};return Promise.race([e,t]).then(e=>e===t?"pending":"fulfilled",()=>"rejected")},delay:e=>new Promise(t=>setTimeout(t,e)),retry:(e,t,n)=>0===t?Promise.reject(n):Promise.resolve(e(n,t)).then(n=>n||s.async.retry(e,t-1,n)),retryDelay(e,t,n,o){const i=t=>s.async.delay(n).then(()=>e(t));try{return 0===t?Promise.reject(o):Promise.resolve(e(t)).then(e=>e||s.async.retryDelay(i,t-1))}catch(e){return Promise.reject(e)}},find:(e,t,n=null)=>e&&0!==e.length?Promise.resolve(t(e[0])).then(o=>o?e[0]:s.async.find(e.slice(1),t,n)):Promise.resolve(void 0)},s.dom={onDOMReady:()=>new Promise(e=>{"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)}),forEach(e,t,n){const o=[...e];for(let e=0;e<o.length;e++)t.call(n||window,o[e],e)},wrap:(e,t)=>(e.parentNode.insertBefore(t,e),t.appendChild(e),t),wrapAll(e,t){if(e&&e.length){const n=Array.prototype.slice.call(e);n[0].parentNode.insertBefore(t,n[0]),n.forEach(e=>t.appendChild(e))}return t},createElement(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}},s.dot={set(e,t,n){const o=t.split(".");s.throwIf(!o.length);const i=o.pop();o.reduce((e,t)=>e[t]={},e)[i]=n},get:(e,t)=>t.split(".").reduce((e,t)=>void 0!==e?e[t]:void 0,e)};const a={_PREFIX:"dcs",_TAG_PART_REGEX:/[^0-9A-Za-z_]+/g,_settings:null,init(e){s.dev.assert("number"==typeof e.maxPageNameLength&&e.maxPageNameLength>=1),s.dev.assert("number"==typeof e.maxTriggerIdLength&&e.maxTriggerIdLength>=1),s.dev.assert("boolean"==typeof e.forceLowercase),a._settings=e},_checkInit(){s.dev.assert(a._settings,"DcsTag not initialized")},getSettings:()=>(a._checkInit(),a._settings),build:({pageName:e,triggerId:t})=>(a.checkPartThrow(e,"pageName",a._settings.maxPageNameLength),t&&a.checkPartThrow(t,"triggerId",a._settings.maxTriggerIdLength),t?`${a._PREFIX}-${e}-${t}`:`${a._PREFIX}-${e}`),parse(e){a._checkInit();const t=e.split("-");if(t.shift()!==a._PREFIX)return null;const n=t.shift();if(!a.checkPart(n,a._settings.maxPageNameLength))return null;const o=t.shift();return o&&!a.checkPart(o,a._settings.maxTriggerIdLength)?null:{pageName:n,triggerId:o}},maxTagLength:()=>(a._checkInit(),a._PREFIX.length+a._settings.maxPageNameLength+a._settings.maxTriggerIdLength+2),checkPart:(e,t)=>(a._checkInit(),e&&e.length<=t&&!e.match(a._TAG_PART_REGEX)&&(!a.forceLowercaseTags||e===e.toLowerCase())),checkPartThrow(e,t,n){a.checkPart(e,n)||s.throw(`Invalid dcsTag part ${t}="${e}"`)},cleanPart(e,t){const n=e.substring(0,t).replace(a._TAG_PART_REGEX,"_");return a.forceLowercase?n.toLowerCase():n}};const l=new class{constructor(){this._bellhop=new r,this._timer=null,this._onConnected=null,this._bellhop.on("connected",()=>{this._timer&&(clearTimeout(this._timer),this._timer=null),this._onConnected&&this._onConnected()})}connect({discourseOrigin:e,onConnected:t,timeout:n,onTimeout:o}){s.throwIf(!s.inIFrame()),this._onConnected=t,this._timer=n?setTimeout(()=>{o&&o()},n):null,this._bellhop.connect(void 0,e)}onDiscourseRoutePushed(e){this._bellhop.on("m2",t=>e(t.data))}onCountsChanged(e){this._bellhop.on("m3",t=>e(t.data))}postSetDiscourseRoute({route:e,mode:t,clientContext:n}){this._bellhop.send("m4",arguments[0])}postSetHash({hash:e,mode:t}){this._bellhop.send("m5",arguments[0])}postSetRouteProps({category:e,discourseTitle:t,error:n}){this._bellhop.send("m6",arguments[0])}postSetRedirects(e){this._bellhop.send("m7",e)}};export{a as DcsTag,l as comToPlugin,s as u};
