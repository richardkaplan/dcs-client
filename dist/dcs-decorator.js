!function(){"use strict";const e={windowName:()=>{let e="Docuss";return(e="undefined"!=typeof window?window.name.trim()||document.title.trim()||e:require(__dirname+"/package.json").name||e).substring(0,12)},log:(...t)=>{t=[`%c${e.windowName()} -`,"color:grey",...t],console.log(...t)},logError:(...t)=>{t=[`%c${e.windowName()} %c- Docuss Error -`,"color:grey","color:red",...t],console.log(...t)},logWarning:(...t)=>{t=[`%c${e.windowName()} %c- Docuss Warning -`,"color:grey","color:orange",...t],console.log(...t)}};class t extends Error{constructor(e){super(e),this.name="DocussError"}}e.throw=(e=>{throw new t(e)}),e.throwIf=((t,n)=>t&&e.throw(n)),e.throwIfNot=((t,n)=>!t&&e.throw(n)),e.dev={assert:(t,n)=>e.throwIf(!t,`Assertion Failed${n?" - "+n:""}`),log:e.log,logWarning:e.logWarning,logError:e.logError},e.inIFrame=(()=>{try{return window.self!==window.top}catch(e){return!0}}),e.async={promiseState(e){const t={};return Promise.race([e,t]).then(e=>e===t?"pending":"fulfilled",()=>"rejected")},delay:e=>new Promise(t=>setTimeout(t,e)),retry:(t,n,o)=>0===n?Promise.reject(o):Promise.resolve(t(o,n)).then(o=>o||e.async.retry(t,n-1,o)),retryDelay(t,n,o,s){const i=n=>e.async.delay(o).then(()=>t(n));try{return 0===n?Promise.reject(s):Promise.resolve(t(n)).then(t=>t||e.async.retryDelay(i,n-1))}catch(e){return Promise.reject(e)}},find:(t,n,o=null)=>t&&0!==t.length?Promise.resolve(n(t[0])).then(s=>s?t[0]:e.async.find(t.slice(1),n,o)):Promise.resolve(void 0)},e.dom={onDOMReady:()=>new Promise(e=>{"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)}),forEach(e,t,n){const o=[...e];for(let e=0;e<o.length;e++)t.call(n||window,o[e],e)},wrap:(e,t)=>(e.parentNode.insertBefore(t,e),t.appendChild(e),t),wrapAll(e,t){if(e&&e.length){const n=Array.prototype.slice.call(e);n[0].parentNode.insertBefore(t,n[0]),n.forEach(e=>t.appendChild(e))}return t},createElement(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}},e.dot={set(t,n,o){const s=n.split(".");e.throwIf(!s.length);const i=s.pop();s.reduce((e,t)=>e[t]={},t)[i]=o},get:(e,t)=>t.split(".").reduce((e,t)=>void 0!==e?e[t]:void 0,e)};const n={_PREFIX:"dcs",_TAG_PART_REGEX:/[^0-9A-Za-z_]+/g,_settings:null,init(t){e.dev.assert("number"==typeof t.maxPageNameLength&&t.maxPageNameLength>=1),e.dev.assert("number"==typeof t.maxTriggerIdLength&&t.maxTriggerIdLength>=1),e.dev.assert("boolean"==typeof t.forceLowercase),n._settings=t},_checkInit(){e.dev.assert(n._settings,"DcsTag not initialized")},getSettings:()=>(n._checkInit(),n._settings),build:({pageName:e,triggerId:t})=>(n.checkPartThrow(e,"pageName",n._settings.maxPageNameLength),t&&n.checkPartThrow(t,"triggerId",n._settings.maxTriggerIdLength),t?`${n._PREFIX}-${e}-${t}`:`${n._PREFIX}-${e}`),parse(e){n._checkInit();const t=e.split("-");if(t.shift()!==n._PREFIX)return null;const o=t.shift();if(!n.checkPart(o,n._settings.maxPageNameLength))return null;const s=t.shift();return s&&!n.checkPart(s,n._settings.maxTriggerIdLength)?null:{pageName:o,triggerId:s}},maxTagLength:()=>(n._checkInit(),n._PREFIX.length+n._settings.maxPageNameLength+n._settings.maxTriggerIdLength+2),checkPart:(e,t)=>(n._checkInit(),e&&e.length<=t&&!e.match(n._TAG_PART_REGEX)&&(!n.forceLowercaseTags||e===e.toLowerCase())),checkPartThrow(t,o,s){n.checkPart(t,s)||e.throw(`Invalid dcsTag part ${o}="${t}"`)},cleanPart:(e,t)=>e.substring(0,t).replace(n._TAG_PART_REGEX,"_")};var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(){function e(){s(this,e),this._listeners={}}return i(e,[{key:"on",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._listeners[e]||(this._listeners[e]=[]),t._priority=parseInt(n)||0,-1===this._listeners[e].indexOf(t)&&(this._listeners[e].push(t),this._listeners[e].length>1&&this._listeners[e].sort(this.listenerSorter))}},{key:"listenerSorter",value:function(e,t){return e._priority-t._priority}},{key:"off",value:function(e,t){if(void 0!==this._listeners[e])if(void 0!==t){var n=this._listeners[e].indexOf(t);-1<n&&this._listeners[e].splice(n,1)}else delete this._listeners[e]}},{key:"trigger",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e&&(e={type:e,data:"object"===(void 0===t?"undefined":o(t))&&null!==t?t:{}}),void 0!==this._listeners[e.type])for(var n=this._listeners[e.type].length-1;n>=0;n--)this._listeners[e.type][n](e)}},{key:"destroy",value:function(){this._listeners={}}}]),e}(),a=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100*Math.random()|0;s(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.id="BELLHOP:"+e,n.connected=!1,n.isChild=!0,n.connecting=!1,n.origin="*",n._sendLater=[],n.iframe=null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,c),i(t,[{key:"receive",value:function(e){if(this.target===e.source)if("connected"===e.data)this.onConnectionReceived(e.data);else{var t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Bellhop error: ",e)}this.connected&&"object"===(void 0===t?"undefined":o(t))&&t.type&&this.trigger(t)}}},{key:"onConnectionReceived",value:function(e){this.connecting=!1,this.connected=!0,this.isChild||this.target.postMessage(e,this.origin);for(var t=0;t<this._sendLater.length;t++){var n=this._sendLater[t],o=n.type,s=n.data;this.send(o,s)}this._sendLater.length=0,this.trigger("connected")}},{key:"connect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"*";this.connecting||(this.disconnect(),this.connecting=!0,e instanceof HTMLIFrameElement&&(this.iframe=e),this.isChild=void 0===e,this.supported=!0,this.isChild&&(this.supported=window!=e),this.origin=t,window.addEventListener("message",this.receive.bind(this)),this.isChild&&(window===this.target?this.trigger("failed"):this.target.postMessage("connected",this.origin)))}},{key:"disconnect",value:function(){this.connected=!1,this.connecting=!1,this.origin=null,this.iframe=null,this.isChild=!0,this._sendLater.length=0,window.removeEventListener("message",this.receive)}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"!=typeof e)throw"The event type must be a string";var n={type:e,data:t};this.connecting?this._sendLater.push(n):this.target.postMessage(JSON.stringify(n),this.origin)}},{key:"fetch",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";this.on(e,function e(o){s&&n.off(o.type,e),t(o)}),this.send(e,o)}},{key:"respond",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(e,function s(i){o&&t.off(i.type,s),t.send(e,"function"==typeof n?n():n)})}},{key:"destroy",value:function(){(function e(t,n,o){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,n);if(void 0===s){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,o)}if("value"in s)return s.value;var r=s.get;return void 0!==r?r.call(o):void 0})(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.disconnect(),this._sendLater.length=0}},{key:"target",get:function(){return this.isChild?window.parent:this.iframe.contentWindow}}]),t}();const l=new class{constructor(){this._bellhop=new a,this._timer=null,this._onConnected=null,this._bellhop.on("connected",()=>{this._timer&&(clearTimeout(this._timer),this._timer=null),this._onConnected&&this._onConnected()})}connect({discourseOrigin:t,onConnected:n,timeout:o,onTimeout:s}){e.throwIf(!e.inIFrame()),this._onConnected=n,this._timer=o?setTimeout(()=>{s&&s()},o):null,this._bellhop.connect(void 0,t)}onDiscourseRoutePushed(e){this._bellhop.on("m2",t=>e(t.data))}onCountsChanged(e){this._bellhop.on("m3",t=>e(t.data))}postSetDiscourseRoute({route:e,mode:t,clientContext:n}){this._bellhop.send("m4",arguments[0])}postSetHash({hash:e,mode:t}){this._bellhop.send("m5",arguments[0])}postSetRouteProps({category:e,discourseTitle:t,error:n}){this._bellhop.send("m6",arguments[0])}postSetRedirects(e){this._bellhop.send("m7",e)}};function d(e){const t=e.getBoundingClientRect();t.top<window.innerHeight&&t.bottom>=0||(e.scrollIntoView(),window.scrollBy(0,-50))}const g=new class{constructor(){this.selTriggerNode=null,this.resizeTimer=null,l.onDiscourseRoutePushed(this._onDiscourseRoutePushed.bind(this)),l.onCountsChanged(({counts:e})=>console.log("counts: ",e))}connect({discourseOrigin:e,timeout:t}){return new Promise((n,o)=>{this.resolveInit=n,l.connect({discourseOrigin:e,timeout:t,onTimeout:()=>o("timeout")})})}parseDom({descr:t,pageName:n,counts:o}){return(t.staticPages||[]).forEach(e=>{let t=new URL(e.url,location.href);e.url=t.href}),e.dom.onDOMReady().then(()=>{e.dom.forEach(document.getElementsByTagName("a"),e=>{if(e.dataset.dcsDiscourseLink)e.onclick=(t=>{t.preventDefault(),t.stopPropagation(),l.postSetDiscourseRoute({route:{layout:"FULL_DISCOURSE",path:e.pathname},mode:"PUSH",clientContext:!0})});else if(e.href.split("#")[0]===location.href.split("#")[0])e.onclick=(()=>{l.postSetHash({hash:e.hash,mode:"REPLACE"})});else{const n=e.href.split("#")[0],o=t.staticPages.find(e=>e.url===n);o?(e.href=document.referrer+"docuss/"+o.name,e.target&&"_self"!==e.target||(e.onclick=(e=>{e.preventDefault(),e.stopPropagation(),l.postSetDiscourseRoute({route:{layout:"FULL_CLIENT",pageName:o.name},mode:"PUSH",clientContext:!0})}))):e.target&&"_self"!==e.target||(e.target="_parent")}});const o=document.getElementsByClassName("dcs-trigger"),s={};e.dom.forEach(o,e=>{const t=e.dataset.dcsTriggerId,n=s[t]||!!e.dataset.dcsHighlightable;s[t]=n});const i=Object.keys(s).filter(e=>!s[e]).map(e=>({src:{layout:"WITH_SPLIT_BAR",triggerId:e,showRight:!1},dest:{layout:"FULL_CLIENT"}}));l.postSetRedirects(i),e.dom.forEach(document.querySelectorAll(".dcs-icons, .dcs-trigger.dcs-no-balloon .dcs-trigger-span, .dcs-trigger.dcs-no-balloon.dcs-no-span"),e=>{e.onclick=(e=>{if(window.getSelection().toString())return;const t=e.target.closest(".dcs-trigger"),o=t.dataset.dcsTriggerId;this._selectTriggers(o),l.postSetDiscourseRoute({route:{layout:"WITH_SPLIT_BAR",pageName:t.dataset.dcsPageName||n,triggerId:o,interactMode:t.dataset.dcsInteractMode,showRight:!0},mode:"PUSH",clientContext:!0}),e.stopPropagation()})}),this.runReady=!0,window.addEventListener("click",()=>{this.selTriggerNode&&this.selTriggerNode.dataset.dcsHighlightable&&(this._selectTriggers(null),l.postSetDiscourseRoute({route:{layout:"FULL_CLIENT",pageName:n},mode:"PUSH",clientContext:!0}))}),window.addEventListener("resize",e=>{null!==this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>{this.resizeTimer=null,this.selTriggerNode&&d(this.selTriggerNode)},100)}),this.delayedRoute&&this._onDiscourseRoutePushed({route:this.delayedRoute})})}_onDiscourseRoutePushed({route:e,descr:t,counts:o,clientContext:s}){if(this.resolveInit)return this.resolveInit({descr:t,pageName:e.pageName,counts:o}),delete this.resolveInit,n.init(t.dcsTag),this.runReady=!1,void(this.delayedRoute=e);if(this.runReady){if("WITH_SPLIT_BAR"===e.layout){const t=e.triggerId&&document.querySelector(`.dcs-trigger[data-dcs-trigger-id="${e.triggerId}"]`),n=t&&t.dataset.dcsCategory||document.documentElement.dataset.dcsCategory,o=t&&t.dataset.dcsDiscourseTitle||document.documentElement.dataset.dcsDiscourseTitle;l.postSetRouteProps({category:n,discourseTitle:o})}s||this._selectTriggers(e.triggerId)}else this.delayedRoute=e}_selectTriggers(t){if(this.selTriggerNode=null,e.dom.forEach(document.getElementsByClassName("dcs-highlighted"),e=>e.classList.remove("dcs-highlighted")),!t)return;const n=document.querySelectorAll(`.dcs-trigger[data-dcs-trigger-id="${t}"]`);n.length?(e.dom.forEach(n,e=>{if(e.dataset.dcsHighlightable){e.classList.add("dcs-highlighted");const t=e.closest(".dcs-subsec");t&&t.classList.add("dcs-highlighted")}}),this.selTriggerNode=n[0],setTimeout(()=>d(this.selTriggerNode),700)):l.postSetRouteProps({error:error})}};let u,h;function m(t,n,o){const s=(n||document).querySelectorAll(t.ui.cssSelector);e.dom.forEach(s,(s,i)=>{let r;if(r="GENERATE_FROM_HTML_ID"===t.ids[0]?p(s,n):"GENERATE"===t.ids[0]?p(null,null):t.ids[i%t.ids.length],s.dataset.dcsTriggerId=r,s.dataset.dcsInteractMode=t.interactMode,t.category&&(s.dataset.dcsCategory=t.category),t.discourseTitle&&(s.dataset.dcsDiscourseTitle=t.discourseTitle),t.ui.highlightable&&(s.dataset.dcsHighlightable=!0),s.classList.add("dcs-trigger"),t.ui.insertTextSpan){const t=document.createTreeWalker(s,NodeFilter.SHOW_TEXT,null,!1);let n;for(;n=t.nextNode();)n.data.trim()&&e.dom.wrap(n,e.dom.createElement('<span class="dcs-trigger-span"></span>'))}else s.classList.add("dcs-no-span");let c="";if(t.ui.insertBalloon?c+='<i class="fas fa-comment"></i>':s.classList.add("dcs-no-balloon"),t.ui.insertCountBadge){const e=o.find(e=>e.triggerId===r);e&&0!==e.count&&(c+=` \n        <div class="dcs-badge" title="This section has ${e.count} topic(s)">\n          ${e.count}\n        </div>\n      `)}c&&s.appendChild(e.dom.createElement(`\n        <span class="dcs-icons" title="Click to discuss this subsection">\n          ${c}\n        </span>\n      `))})}function p(t,o){let s=t&&function(e,t){if(e.id)return e.id;const n=e.querySelectorAll('[id]:not([id=""])');if(n.length)return n[0].id;let o=e.parentElement;for(;o&&!o.getElementsByClassName("dcs-trigger").length;){if(o.id)return o.id;o=o.parentElement}if(t){const e=t.querySelectorAll('[id]:not([id=""])');if(e.length)return e[0].id}return null}(t,o);s||(s=`gen${h.length}`,h.push({Text:t.innerText.trim(),"Generated Id":s}));const i=n.getSettings().maxTriggerIdLength;let r=n.cleanPart(s,i);if(u.includes(r)){const t=r;for(let n=1;;++n){const o=n.toString();if(e.throwIf(o.length>i,"too many duplicated html ids"),r=t.substring(0,i-o.length)+o,!u.includes(r))break}}return u.push(r),r}function f(e,t){return"*"===t[0]||t.includes(e)}e.inIFrame()?(e.log("Docuss Decorator - Initializing..."),g.connect({discourseOrigin:"*",timeout:1e4}).then(t=>(function({descr:t,pageName:n,counts:o}){const s=t.clientData&&t.clientData.decorator;if(!s)throw"No decorator found in json descriptor";const i=(s.injectCss||[]).reduce((e,t)=>f(n,t.pageNames)?e.concat(t.css):e,[]);if(i.length){const e=document.createElement("style");e.type="text/css",e.innerHTML=i.join("\n"),document.head.appendChild(e)}const r=(s.pageProperties||[]).filter(e=>f(n,e.pageNames)).pop(),c=r&&r.category||s.category,a=r&&r.discourseTitle||s.discourseTitle;c&&(document.documentElement.dataset.dcsCategory=c);a&&(document.documentElement.dataset.dcsDiscourseTitle=a);const l=(s.injectTriggers||[]).filter(e=>f(n,e.pageNames)),d=o.filter(e=>e.pageName===n);return e.dom.onDOMReady().then(()=>(function(t,n){if((!!document.querySelectorAll(".dcs-subsec, .dcs-trigger, .dcs-icons, .dcs-badge")).length)throw"The page already contains Docuss markup";h=[],u=t.reduce((e,t)=>Array.isArray(t.ids)?e.concat(t.ids):e,[]),t.forEach(t=>(function(t,n){if(!t.ui.subsection)return void m(t,null,n);const o=t.ui.subsection,s=document.querySelectorAll(o.begin);s.length||e.logWarning(`Found nothing with begin="${o.begin}"`),e.dom.forEach(s,s=>{for(;s.parentNode&&1===s.parentNode.querySelectorAll(o.begin).length&&(!o.end||0===s.parentNode.querySelectorAll(o.end).length);)s=s.parentNode;const i=o.begin+(o.end?","+o.end:""),r=[s];let c=s.nextSibling;for(;c&&(1!==c.nodeType||!c.matches(i)&&!c.querySelectorAll(i).length);)r.push(c),c=c.nextSibling;const a=document.createElement("div");a.classList.add("dcs-subsec"),e.dom.wrapAll(r,a),m(t,a,n)})})(t,n)),h.length&&e.logWarning('Those triggers with id="GENERATE_FROM_HTML_ID" were assigned generated ids because no html id was found:',h)}(l,d),e.log("Docuss Decorator - Ready"),{descr:t,pageName:n,counts:o}))})(t)).then(e=>g.parseDom(e)).catch(t=>{if("string"!=typeof t)throw t;e.logError("Decorator - "+t)})):e.log("Docuss Decorator - Could not run, as the page is not displayed in a Docuss iframe")}();
//# sourceMappingURL=dcs-decorator.js.map
